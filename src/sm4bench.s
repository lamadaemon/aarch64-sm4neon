.global main

// Encrypt Same Block for 1M times
main:
    stp x21, x30, [sp, -0x10]!

    bl sm4_initialize_cache

    mov x0, 128
    bl malloc
    mov x23, x0
    
    mov x0, 128
    bl malloc

    movz w1, 0x4567
    movk w1, 0x0123, lsl 16
    movz w2, 0xcdef
    movk w2, 0x89ab, lsl 16
    movz w3, 0xba98
    movk w3, 0xfedc, lsl 16
    movz w4, 0x3210
    movk w4, 0x7654, lsl 16
    bl sm4_key_expansion

    adr x24, loop_times
    ldr w25, [x24]
    
    adr x1, enc_data
    mov x2, x23
1:  cbz w25, 2f
    
    bl sm4neon_encrypt_block4
   
    // We do 4 blocks at the same time!
    sub x25, x25, 4
    b 1b

2:  mov x0, x26
    bl free

    mov x0, x23
    bl free

    ldp x21, x30, [sp], 0x10
    mov x0, xzr
    ret

.data
loop_times:
    .word 1000000
enc_data:
    .byte 0x67, 0x45, 0x23, 0x01, 0xef, 0xcd, 0xab, 0x89, 0x98, 0xba, 0xdc, 0xfe, 0x10, 0x32, 0x54, 0x76, 0x67, 0x45, 0x23, 0x01, 0xef, 0xcd, 0xab, 0x89, 0x98, 0xba, 0xdc, 0xfe, 0x10, 0x32, 0x54, 0x76, 0x67, 0x45, 0x23, 0x01, 0xef, 0xcd, 0xab, 0x89, 0x98, 0xba, 0xdc, 0xfe, 0x10, 0x32, 0x54, 0x76, 0x67, 0x45, 0x23, 0x01, 0xef, 0xcd, 0xab, 0x89, 0x98, 0xba, 0xdc, 0xfe, 0x10, 0x32, 0x54, 0x76

